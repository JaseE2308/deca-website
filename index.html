<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Team Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #ffffff;
      --ink: #0b0f19;
      --muted: #5b6578;
      --border: #e3e8ef;
      --theme: #98bcc5;       /* requested theme color */
      --theme-ink: #0b2a2f;   /* darker text for contrast on themed accents */
      --radius: 16px;
    }

    /* Typography: Helvetica for all; bold titles */
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    h1, h2, h3 { font-weight: 700; margin: 0 0 10px; }
    h1 { font-size: 32px; }
    h2 { font-size: 24px; }
    h3 { font-size: 18px; }
    p, li { line-height: 1.5; }

    /* Layout */
    .container { width: min(1050px, 100%); margin: 0 auto; padding: 24px; }
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: 0 8px 20px rgba(16, 24, 40, 0.06);
    }
    .space { height: 16px; }
    .muted { color: var(--muted); font-size: 14px; }

    /* Top nav */
    .topbar-wrap { background: #ffffff; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
    .topbar {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      width: min(1050px, 100%); margin: 0 auto; padding: 12px 24px;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand .dot { width: 12px; height: 12px; background: var(--theme); border-radius: 999px; border: 1px solid #6fa0ab; }
    .brand h1 { font-size: 22px; margin: 0; }

    .menu { display: flex; gap: 8px; flex-wrap: wrap; }
    .menu a {
      text-decoration: none; color: var(--ink); padding: 8px 12px; border-radius: 12px; border: 1px solid transparent;
      font-weight: 600;
    }
    .menu a.active, .menu a:hover {
      background: var(--theme); border-color: #6fa0ab; color: var(--theme-ink);
      transition: background .15s ease, color .15s ease, border .15s ease;
    }

    /* Buttons + inputs */
    input, button, select, textarea {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 16px;
    }
    input {
      background: #fff; color: var(--ink); border: 1px solid var(--border);
      border-radius: 10px; padding: 10px 12px; outline: none; width: 100%;
    }
    button {
      background: var(--theme); color: var(--theme-ink); border: 1px solid #6fa0ab;
      border-radius: 12px; padding: 10px 14px; font-weight: 700; cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }

    /* Table */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; }
    th { font-weight: 700; font-size: 14px; color: var(--muted); }
    td { font-size: 16px; }
    .right { text-align: right; }

    .pill {
      font-size: 12px; padding: 4px 8px; border-radius: 999px; background: #eef6f8; border: 1px solid #cbe2e7; color: #2b4650;
    }
    .row { display: flex; gap: 12px; align-items: center; }
    .row-stretch { display: flex; gap: 12px; align-items: stretch; }
    .error { color: #b42318; font-size: 14px; }

    /* Pages */
    .page { display: none; }
    .page.active { display: block; }

    /* Content helpers */
    .prose p { margin: 0 0 10px; }
    .list-tight li { margin: 6px 0; }

    /* Footer */
    footer { border-top: 1px solid var(--border); margin-top: 24px; padding-top: 16px; color: var(--muted); font-size: 14px; }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <div class="topbar-wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <h1>Team Leaderboard</h1>
      </div>
      <nav class="menu" id="menu">
        <a href="#home" data-page="home" class="active">Home</a>
        <a href="#incentive" data-page="incentive">Incentive</a>
        <a href="#tips" data-page="tips">Fundraising Tips</a>
        <a href="#mission" data-page="mission">Mission</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <!-- AUTH STATUS (shown on Home only) -->
    <div id="auth-status" class="row muted" style="justify-content:flex-end; display:none;"></div>

    <!-- ========== HOME (Leaderboard + Auth) ========== -->
    <section id="page-home" class="page active">
      <div class="card" id="leaderboard-card">
        <h2>Leaderboard</h2>
        <table id="board">
          <thead>
            <tr><th>#</th><th>Team</th><th class="right">Total</th></tr>
          </thead>
          <tbody id="board-body"></tbody>
        </table>
        <div class="space"></div>
        <div class="muted">Updates in real time.</div>
      </div>

      <div class="space"></div>

      <div class="row-stretch" style="flex-wrap:wrap;">
        <!-- Login -->
        <div class="card" id="login-card" style="flex:1 1 420px;">
          <h3>Sign in to add to your team‚Äôs total</h3>
          <div class="space"></div>
          <div class="row" style="align-items:flex-start; gap:12px;">
            <input id="email" type="email" placeholder="email@example.com" />
            <input id="password" type="password" placeholder="password" />
            <button id="login-btn">Log in</button>
          </div>
          <div id="login-error" class="error" style="margin-top:8px;"></div>
          <div class="space"></div>
          <div class="muted">Accounts are pre-created by admins.</div>
        </div>

        <!-- Add dollars -->
        <div class="card" id="add-card" style="display:none; flex:1 1 420px;">
          <div class="row" style="justify-content:space-between;">
            <h3>Add to Team Total</h3>
            <button id="logout-btn" title="Sign out">Log out</button>
          </div>
          <div class="space"></div>
          <div class="row" style="justify-content:space-between;">
            <span class="pill" id="team-pill">Team: ‚Äî</span>
          </div>
          <div class="space"></div>
          <div class="row" style="gap:12px;">
            <input id="amount" type="number" min="1" step="0.01" placeholder="Amount in USD" />
            <button id="add-btn">Add</button>
          </div>
          <div id="add-error" class="error" style="margin-top:8px;"></div>
          <div class="muted" style="margin-top:8px;">Only positive amounts allowed. Access is enforced by database policies.</div>
        </div>
      </div>
    </section>

    <!-- ========== INCENTIVE PAGE ========== -->
    <section id="page-incentive" class="page">
      <div class="card">
        <h2>Incentive for the Winning Team</h2>
        <div class="space"></div>
        <div class="prose">
          <!-- üëâ Replace this content with your real incentive details -->
          <p><strong>What teams win:</strong> [Describe prize / recognition / grant / event].</p>
          <ul class="list-tight">
            <li>Eligibility: [criteria]</li>
            <li>How the winner is selected: [tie-breakers, deadlines]</li>
            <li>Distribution timeline: [when/how rewards are delivered]</li>
          </ul>
          <p class="muted">Edit this section in <code>index.html</code> under the ‚ÄúIncentive‚Äù page.</p>
        </div>
      </div>
    </section>

    <!-- ========== FUNDRAISING TIPS PAGE ========== -->
    <section id="page-tips" class="page">
      <div class="card">
        <h2>Fundraising Tips</h2>
        <div class="space"></div>
        <!-- üëâ Insert articles here. You can duplicate <article> blocks. -->
        <article class="prose" style="border-top:1px solid var(--border); padding-top:12px;">
          <h3>Article Title Placeholder</h3>
          <p>[Intro/summary paragraph goes here.]</p>
          <ul class="list-tight">
            <li>Tip #1 ‚Ä¶</li>
            <li>Tip #2 ‚Ä¶</li>
            <li>Tip #3 ‚Ä¶</li>
          </ul>
        </article>

        <article class="prose" style="border-top:1px solid var(--border); padding-top:12px;">
          <h3>Another Article Title</h3>
          <p>[Add your content or link out.]</p>
        </article>

        <div class="space"></div>
        <div class="muted">Add or remove <code>&lt;article&gt;</code> blocks as needed.</div>
      </div>
    </section>

    <!-- ========== MISSION PAGE ========== -->
    <section id="page-mission" class="page">
      <div class="card">
        <h2>Our Mission</h2>
        <div class="space"></div>
        <div class="prose">
          <!-- üëâ Replace with your mission statement -->
          <p>
            [Insert your organization‚Äôs mission statement here. Keep it concise and impactful‚Äî
            one to three short paragraphs is ideal.]
          </p>
        </div>
      </div>
    </section>

    <footer class="container">
      <div class="muted">¬© <span id="year"></span> Team Leaderboard</div>
    </footer>
  </div>

  <!-- Supabase client + App logic -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ====== Configure Supabase ======
    const SUPABASE_URL = "https://sjhlxejgrnhslbunjvyc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaGx4ZWpncm5oc2xidW5qdnljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5Njk5MDYsImV4cCI6MjA3MzU0NTkwNn0.YrFBgLhcdho7aLv1vrrYPqAJ2rGm-Zn3SKLkGgyvpJ8";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // ====== Helpers ======
    const $ = (id) => document.getElementById(id);
    const boardBody = $("board-body");
    const loginCard = $("login-card");
    const addCard = $("add-card");
    const teamPill = $("team-pill");
    const loginBtn = $("login-btn");
    const logoutBtn = $("logout-btn");
    const addBtn = $("add-btn");
    const authStatus = $("auth-status");
    const yearSpan = $("year");

    let myTeamId = null;

    const fmtUSD = (cents) =>
      new Intl.NumberFormat(undefined, { style: "currency", currency: "USD" })
        .format((cents ?? 0) / 100);

    async function loadBoard() {
      const { data, error } = await supabase
        .from("teams")
        .select("id,name,total_cents")
        .order("total_cents", { ascending: false })
        .limit(100);

      if (error) {
        console.error(error);
        boardBody.innerHTML = `<tr><td colspan="3" class="error">Failed to load leaderboard</td></tr>`;
        return;
      }

      boardBody.innerHTML = data.map((t, i) =>
        `<tr>
          <td>${i + 1}</td>
          <td>${t.name}</td>
          <td class="right">${fmtUSD(t.total_cents)}</td>
        </tr>`
      ).join("");
    }

    function subscribeRealtime() {
      supabase.channel('teams-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'teams' }, loadBoard)
        .subscribe();
    }

    async function refreshAuthUI() {
      const { data: { user } } = await supabase.auth.getUser();

      // Only show auth status on Home page
      authStatus.style.display = isCurrentPage('home') ? "flex" : "none";
      authStatus.innerHTML = user
        ? `<span>Signed in as <strong>${user.email}</strong></span>`
        : `<span>Viewing as guest</span>`;

      loginCard.style.display = user ? "none" : "block";
      addCard.style.display = user ? "block" : "none";

      if (user) {
        const { data: membership, error } = await supabase
          .from("team_members")
          .select("team_id, teams(name)")
          .eq("user_id", user.id)
          .limit(1)
          .maybeSingle();

        if (error || !membership) {
          $("add-error").textContent = error?.message || "No team assigned. Contact admin.";
          myTeamId = null;
          teamPill.textContent = "Team: ‚Äî";
          addBtn.disabled = true;
        } else {
          myTeamId = membership.team_id;
          teamPill.textContent = `Team: ${membership.teams.name}`;
          addBtn.disabled = false;
        }
      } else {
        myTeamId = null;
      }
    }

    // ====== Auth actions ======
    loginBtn?.addEventListener("click", async () => {
      $("login-error").textContent = "";
      const email = $("email").value.trim();
      const password = $("password").value;
      loginBtn.disabled = true;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      loginBtn.disabled = false;
      if (error) $("login-error").textContent = error.message;
      await refreshAuthUI();
    });

    logoutBtn?.addEventListener("click", async () => {
      await supabase.auth.signOut();
      await refreshAuthUI();
    });

    addBtn?.addEventListener("click", async () => {
      $("add-error").textContent = "";
      const amountStr = $("amount").value;
      const amount = parseFloat(amountStr);
      if (!myTeamId) {
        $("add-error").textContent = "No team assigned to your account.";
        return;
      }
      if (!(amount > 0)) {
        $("add-error").textContent = "Enter a positive dollar amount.";
        return;
      }
      addBtn.disabled = true;
      const cents = Math.round(amount * 100);
      const { error } = await supabase.rpc("increment_team_total", { p_team_id: myTeamId, p_amount_cents: cents });
      addBtn.disabled = false;
      if (error) {
        $("add-error").textContent = error.message;
      } else {
        $("amount").value = "";
        loadBoard(); // realtime will also update
      }
    });

    // ====== Simple router (hash-based) ======
    const pages = ["home", "incentive", "tips", "mission"];
    const pageEls = Object.fromEntries(pages.map(p => [p, document.getElementById(`page-${p}`)]));

    function isCurrentPage(p) { return location.hash.replace('#','') === p || (!location.hash && p === 'home'); }

    function showPage(page) {
      pages.forEach(p => {
        pageEls[p].classList.toggle("active", p === page);
        const link = document.querySelector(`.menu a[data-page="${p}"]`);
        if (link) link.classList.toggle("active", p === page);
      });
      // Home-only elements:
      authStatus.style.display = page === 'home' ? "flex" : "none";
    }

    function route() {
      const h = (location.hash || "#home").slice(1);
      if (!pages.includes(h)) location.hash = "#home";
      showPage(h);
      // Refresh auth status when coming back to Home
      if (h === 'home') refreshAuthUI();
    }

    window.addEventListener("hashchange", route);

    // ====== Init ======
    (async function init() {
      yearSpan.textContent = new Date().getFullYear();
      await loadBoard();
      subscribeRealtime();
      route();         // set initial page
      await refreshAuthUI();
    })();
  </script>
</body>
</html>
