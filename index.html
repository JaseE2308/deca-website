<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; background: #0b0f19; color: #f3f5f7; display: grid; place-items: start center; min-height: 100dvh; }
    .wrap { width: min(900px, 100%); padding: 24px; }
    h1 { margin: 0 0 12px; font-size: 28px; font-weight: 800; letter-spacing: .2px; }
    .card { background: #0f1524; border: 1px solid #1f2a44; border-radius: 16px; padding: 16px; box-shadow: 0 10px 20px rgba(0,0,0,.25); }
    .row { display: flex; gap: 8px; align-items: center; }
    .space { height: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; border-bottom: 1px solid #1f2a44; text-align: left; }
    th { font-weight: 700; font-size: 14px; color: #a6b0c3; }
    td { font-size: 16px; }
    .right { text-align: right; }
    input { background: #0b1120; color: #e9eef8; border: 1px solid #223057; border-radius: 10px; padding: 10px 12px; outline: none; width: 100%; }
    button { background: #4f46e5; color: white; border: none; border-radius: 12px; padding: 10px 14px; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .muted { color: #9aa7bd; font-size: 13px; }
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; background: #16203a; border: 1px solid #223057; color: #a6b0c3; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .error { color: #ffb4b4; font-size: 14px; }
    a { color: #93c5fd; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Team Leaderboard</h1>
      <div id="auth-area" class="row"></div>
    </div>
    <div class="card" id="leaderboard-card">
      <table id="board">
        <thead>
          <tr><th>#</th><th>Team</th><th class="right">Total</th></tr>
        </thead>
        <tbody id="board-body"></tbody>
      </table>
      <div class="space"></div>
      <div class="muted">Updates in real time.</div>
    </div>

    <div class="space"></div>

    <div class="card" id="login-card">
      <div class="row" style="gap:12px; align-items:flex-start;">
        <div style="flex:1">
          <div class="muted" style="margin-bottom:8px;">Sign in to add to your team’s total</div>
          <div class="row" style="gap:12px;">
            <input id="email" type="email" placeholder="email@example.com" />
            <input id="password" type="password" placeholder="password" />
            <button id="login-btn">Log in</button>
          </div>
          <div id="login-error" class="error" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>

    <div class="space"></div>

    <div class="card" id="add-card" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div><span class="pill" id="team-pill">Team: —</span></div>
        <button id="logout-btn">Log out</button>
      </div>
      <div class="space"></div>
      <div class="row" style="gap:12px;">
        <input id="amount" type="number" min="1" step="0.01" placeholder="Amount in USD" />
        <button id="add-btn">Add to Team Total</button>
      </div>
      <div id="add-error" class="error" style="margin-top:8px;"></div>
      <div class="muted" style="margin-top:8px;">Only positive amounts allowed. Your identity is enforced by database policies.</div>
    </div>
  </div>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://sjhlxejgrnhslbunjvyc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaGx4ZWpncm5oc2xidW5qdnljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5Njk5MDYsImV4cCI6MjA3MzU0NTkwNn0.YrFBgLhcdho7aLv1vrrYPqAJ2rGm-Zn3SKLkGgyvpJ8";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    const $ = (id) => document.getElementById(id);
    const boardBody = $("board-body");
    const authArea = $("auth-area");
    const loginCard = $("login-card");
    const addCard = $("add-card");
    const teamPill = $("team-pill");
    const loginBtn = $("login-btn");
    const logoutBtn = $("logout-btn");
    const addBtn = $("add-btn");

    let myTeamId = null;

    function fmtUSD(cents) {
      return (cents ?? 0) === 0 ? "$0.00" : new Intl.NumberFormat(undefined, { style: "currency", currency: "USD" })
        .format((cents ?? 0) / 100);
    }

    async function loadBoard() {
      const { data, error } = await supabase
        .from("teams")
        .select("id,name,total_cents")
        .order("total_cents", { ascending: false })
        .limit(100);

      if (error) {
        console.error(error);
        boardBody.innerHTML = `<tr><td colspan="3" class="error">Failed to load leaderboard</td></tr>`;
        return;
      }

      boardBody.innerHTML = data.map((t, i) =>
        `<tr>
          <td>${i + 1}</td>
          <td>${t.name}</td>
          <td class="right">${fmtUSD(t.total_cents)}</td>
        </tr>`
      ).join("");
    }

    // Realtime updates
    function subscribeRealtime() {
      supabase.channel('teams-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'teams' }, loadBoard)
        .subscribe();
    }

    async function refreshAuthUI() {
      const { data: { user } } = await supabase.auth.getUser();
      authArea.innerHTML = user
        ? `<span class="muted">Signed in as ${user.email}</span>`
        : `<span class="muted">Viewing as guest</span>`;

      loginCard.style.display = user ? "none" : "block";
      addCard.style.display = user ? "block" : "none";

      if (user) {
        // find the user’s team
        const { data: membership, error } = await supabase
          .from("team_members")
          .select("team_id, teams(name)")
          .eq("user_id", user.id)
          .limit(1)
          .maybeSingle();

        if (error || !membership) {
          $("add-error").textContent = error?.message || "No team assigned. Contact admin.";
          myTeamId = null;
          teamPill.textContent = "Team: —";
          addBtn.disabled = true;
        } else {
          myTeamId = membership.team_id;
          teamPill.textContent = `Team: ${membership.teams.name}`;
          addBtn.disabled = false;
        }
      } else {
        myTeamId = null;
      }
    }

    loginBtn.onclick = async () => {
      $("login-error").textContent = "";
      const email = $("email").value.trim();
      const password = $("password").value;
      loginBtn.disabled = true;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      loginBtn.disabled = false;
      if (error) $("login-error").textContent = error.message;
      await refreshAuthUI();
    };

    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      await refreshAuthUI();
    };

    addBtn.onclick = async () => {
      $("add-error").textContent = "";
      const amountStr = $("amount").value;
      const amount = parseFloat(amountStr);
      if (!myTeamId) {
        $("add-error").textContent = "No team assigned to your account.";
        return;
      }
      if (!(amount > 0)) {
        $("add-error").textContent = "Enter a positive dollar amount.";
        return;
      }
      addBtn.disabled = true;
      // Convert to cents to avoid floats
      const cents = Math.round(amount * 100);
      const { error } = await supabase.rpc("increment_team_total", { p_team_id: myTeamId, p_amount_cents: cents });
      addBtn.disabled = false;
      if (error) {
        $("add-error").textContent = error.message;
      } else {
        $("amount").value = "";
        // loadBoard() will run by realtime subscription too, but refresh immediately
        loadBoard();
      }
    };

    // Initial load
    (async function init() {
      await loadBoard();
      subscribeRealtime();
      await refreshAuthUI();
    })();
  </script>
</body>
</html>